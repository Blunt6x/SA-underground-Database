
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin - SA Underground</title>
<link rel="stylesheet" href="styles/style.css">
<style>
  /* simple admin overrides */
  .admin-wrap{max-width:900px;margin:24px auto;padding:18px;background:rgba(255,255,255,0.03);border-radius:12px}
  .form-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  .form-row input, .form-row textarea{flex:1;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff}
  .artist-list-admin{
    margin-top:12px;
    border: 1px solid rgba(255,255,255,0.05);
    border-radius: 12px;
    padding: 12px;
    background: rgba(255,255,255,0.01);
  }
  .artist-item{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:12px;
    border-radius:8px;
    background:rgba(255,255,255,0.03);
    margin-bottom:8px;
    transition: all 0.2s ease;
  }
  .artist-item:hover {
    background:rgba(255,255,255,0.05);
    transform: translateY(-2px);
  }
  .artist-item button{
    margin-left:8px;
    opacity: 0.7;
    transition: opacity 0.2s ease;
  }
  .artist-item:hover button {
    opacity: 1;
  }
  .login-box{max-width:420px;margin:20px auto;padding:18px}
  .songs-list { margin-top: 12px; margin-bottom: 24px; }
  .song-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(255,255,255,0.02); margin-bottom: 8px; border-radius: 6px; }
  #image { background-color: rgba(255,255,255,0.02); cursor: default; }
  
  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  
  .delBtn {
    transition: background-color 0.3s, opacity 0.3s;
  }
  .delBtn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }
</style>
</head>
<body>
  <header class="site-header"><div class="brand"><h1>Admin — SA Underground</h1></div></header>
  <main class="container">
    <div id="auth" class="login-box">
      <h3>Admin login</h3>
      <div class="form-row"><input id="user" placeholder="username"></div>
      <div class="form-row"><input id="pass" type="password" placeholder="password"></div>
      <div class="form-row"><button id="loginBtn" class="btn">Log in</button></div>
      <div id="loginMsg" style="color:var(--muted)"></div>
    </div>

    <div id="adminArea" style="display:none">
      <div class="admin-wrap">
        <h3>Manage Music</h3>
        <div class="form-row">
          <input id="songTitle" placeholder="Song Title">
          <input id="songArtist" placeholder="Artist Name">
          <input type="file" id="musicFile" accept="audio/mpeg,audio/mp3" style="display: none;">
          <button class="btn ghost" onclick="document.getElementById('musicFile').click()">Upload Music</button>
        </div>
        <div id="songsList" class="songs-list"></div>

        <h3>Add new artist</h3>
        <div class="form-row">
          <input id="name" placeholder="Name">
          <input id="id" placeholder="id (optional)">
        </div>
        <div class="form-row">
          <input id="followers" placeholder="Followers / monthly_listeners">
          <div style="flex: 1; display: flex; gap: 8px;">
            <input id="image" placeholder="Image path" style="flex: 1;" readonly>
            <input type="file" id="imageFile" accept="image/*" style="display: none;">
            <button class="btn ghost" onclick="document.getElementById('imageFile').click()">Browse</button>
          </div>
        </div>
        <div class="form-row">
          <input id="spotify" placeholder="Spotify URL">
          <input id="instagram" placeholder="Instagram URL">
        </div>
        <div class="form-row">
          <textarea id="bio" placeholder="Bio / city"></textarea>
        </div>
        <div class="form-row">
          <button id="addBtn" class="btn">Add Artist</button>
        </div>

        <h3>Existing artists</h3>
        <div id="artistsAdmin" class="artist-list-admin"></div>
      </div>
    </div>
  </main>

  <footer class="site-footer">
    <small>
      <a href="/">← Back to Home</a> • Made by blunt • © <span id="year"></span>
    </small>
  </footer>

<script>
// HTML sanitizer to prevent XSS
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text || '';
  return div.innerHTML;
}

let token = null;
const loginBtn = document.getElementById('loginBtn');
loginBtn.addEventListener('click', async ()=>{
  const u = document.getElementById('user').value;
  const p = document.getElementById('pass').value;
  const res = await fetch('/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p})});
  if (res.status===200){ 
    const j=await res.json(); 
    token=j.token; 
    document.getElementById('auth').style.display='none'; 
    document.getElementById('adminArea').style.display='block'; 
    await loadArtists(); 
    await loadSongs(); 
    console.log('Loading complete');
  }
  else { document.getElementById('loginMsg').textContent='Invalid creds'; }
});

async function loadArtists(){
  const wrap = document.getElementById('artistsAdmin');
  
  // Show loading state
  wrap.innerHTML = '<div style="text-align:center;color:var(--muted);padding:20px;">Loading artists...</div>';
  
  try {
    const res = await fetch('/api/artists');
    if (!res.ok) {
      throw new Error(`Failed to load artists: ${res.status}`);
    }
    
    const list = await res.json();
    console.log('Artists loaded:', list); // Debug log
    
    wrap.innerHTML = ''; // Clear loading message
    
    if (!list || list.length === 0) {
      wrap.innerHTML = '<div style="text-align:center;color:var(--muted);padding:20px;">No artists added yet</div>';
      return;
    }
    
    list.forEach(a => {
      if (!a || !a.name) return; // Skip invalid entries
      
      const div = document.createElement('div');
      div.className = 'artist-item';
      div.dataset.id = a.id || '';
      div.innerHTML = `
        <div>
          <strong>${escapeHtml(a.name)}</strong>
          ${a.id ? `<small style="color:var(--muted)">(${escapeHtml(a.id)})</small>` : ''}
          ${a.followers ? `<div style="color:var(--muted);font-size:0.9em;margin-top:4px">${escapeHtml(a.followers)}</div>` : ''}
        </div>
        <div>
          <button class="btn ghost editBtn">Edit</button>
          <button class="btn ghost delBtn" style="background:var(--accent2);margin-left:8px;">Delete</button>
        </div>`;
      wrap.appendChild(div);

      div.querySelector('.editBtn').addEventListener('click', () => populateEdit(a));
      div.querySelector('.delBtn').addEventListener('click', () => doDelete(a.id));
    });
  } catch (error) {
    console.error('Error loading artists:', error);
    wrap.innerHTML = `
      <div style="text-align:center;color:var(--accent2);padding:20px;">
        Error loading artists: ${error.message}
        <button onclick="loadArtists()" class="btn ghost" style="margin-top:10px">Try Again</button>
      </div>`;
  }
}

function populateEdit(a){
  document.getElementById('name').value = a.name || '';
  document.getElementById('id').value = a.id || '';
  document.getElementById('followers').value = a.followers || '';
  document.getElementById('image').value = a.image || '';
  document.getElementById('spotify').value = a.spotify || '';
  document.getElementById('instagram').value = a.instagram || '';
  document.getElementById('bio').value = a.bio || '';
  // change add to update
  document.getElementById('addBtn').textContent = 'Update Artist';
  document.getElementById('addBtn').onclick = ()=> doUpdate(a.id);
}

async function doUpdate(id){
  const payload = {
    id: document.getElementById('id').value || id,
    name: document.getElementById('name').value,
    followers: document.getElementById('followers').value,
    image: document.getElementById('image').value,
    spotify: document.getElementById('spotify').value,
    instagram: document.getElementById('instagram').value,
    bio: document.getElementById('bio').value
  };
  const res = await fetch('/api/artists/'+encodeURIComponent(id), {method:'PUT', headers:{'Content-Type':'application/json','X-Auth-Token':token}, body:JSON.stringify(payload)});
  if (res.ok) { alert('Updated'); loadArtists(); resetForm(); }
  else alert('Update failed');
}

async function doDelete(id) {
  try {
    // Create a confirmation dialog with more details
    const confirmResult = confirm('Are you sure you want to delete this artist? This action cannot be undone.');
    if (!confirmResult) return;

    // Show loading state on the delete button
    const deleteBtn = document.querySelector(`[data-id="${id}"] .delBtn`);
    if (deleteBtn) {
      deleteBtn.disabled = true;
      deleteBtn.textContent = 'Deleting...';
    }

    // Make the delete request
    const res = await fetch('/api/artists/' + encodeURIComponent(id), {
      method: 'DELETE',
      headers: {
        'X-Auth-Token': token,
        'Content-Type': 'application/json'
      }
    });

    // Handle the response
    if (res.ok) {
      // Success - show a nicer message and update the list
      const successMsg = document.createElement('div');
      successMsg.style.cssText = 'position:fixed;top:20px;right:20px;background:var(--accent);color:#fff;padding:12px 20px;border-radius:8px;animation:slideIn 0.3s ease;z-index:1000;';
      successMsg.textContent = 'Artist deleted successfully';
      document.body.appendChild(successMsg);
      
      // Remove the message after 3 seconds
      setTimeout(() => successMsg.remove(), 3000);
      
      // Refresh the artists list
      await loadArtists();
    } else {
      // Handle specific error cases
      const errorData = await res.json().catch(() => ({}));
      throw new Error(errorData.message || 'Delete failed');
    }
  } catch (error) {
    console.error('Delete error:', error);
    // Show error message in a nicer way
    const errorMsg = document.createElement('div');
    errorMsg.style.cssText = 'position:fixed;top:20px;right:20px;background:var(--accent2);color:#fff;padding:12px 20px;border-radius:8px;animation:slideIn 0.3s ease;z-index:1000;';
    errorMsg.textContent = error.message || 'Failed to delete artist';
    document.body.appendChild(errorMsg);
    
    // Remove the error message after 5 seconds
    setTimeout(() => errorMsg.remove(), 5000);
  } finally {
    // Reset any delete buttons that might be in loading state
    const deleteButtons = document.querySelectorAll('.delBtn');
    deleteButtons.forEach(btn => {
      btn.disabled = false;
      btn.textContent = 'Delete';
    });
  }
}

document.getElementById('addBtn').addEventListener('click', async ()=>{
  if (document.getElementById('addBtn').textContent === 'Update Artist') return;
  const payload = {
    id: document.getElementById('id').value || undefined,
    name: document.getElementById('name').value,
    followers: document.getElementById('followers').value,
    image: document.getElementById('image').value,
    spotify: document.getElementById('spotify').value,
    instagram: document.getElementById('instagram').value,
    bio: document.getElementById('bio').value
  };
  const res = await fetch('/api/artists', {method:'POST', headers:{'Content-Type':'application/json','X-Auth-Token':token}, body:JSON.stringify(payload)});
  if (res.ok) { alert('Added'); loadArtists(); resetForm(); }
  else { alert('Add failed'); }
});

function resetForm(){
  document.getElementById('name').value = '';
  document.getElementById('id').value = '';
  document.getElementById('followers').value = '';
  document.getElementById('image').value = '';
  document.getElementById('spotify').value = '';
  document.getElementById('instagram').value = '';
  document.getElementById('bio').value = '';
  document.getElementById('addBtn').textContent = 'Add Artist';
  document.getElementById('addBtn').onclick = null;
}

// Music Management
async function loadSongs() {
  try {
    console.log('Fetching songs...');
    const res = await fetch('/api/songs');
    if (!res.ok) {
      throw new Error('Failed to fetch songs: ' + res.status);
    }
    const songs = await res.json();
    console.log('Songs loaded:', songs);
    
    const list = document.getElementById('songsList');
    list.innerHTML = '';
    
    if (songs.length === 0) {
      list.innerHTML = '<div class="song-item"><em style="color:var(--muted)">No songs uploaded yet</em></div>';
      return;
    }
    
    songs.forEach(song => {
      const div = document.createElement('div');
      div.className = 'song-item';
      div.innerHTML = `
        <div>
          <strong>${escapeHtml(song.title)}</strong>
          <small style="color:var(--muted)"> - ${escapeHtml(song.artist)}</small>
        </div>
        <div>
          <audio src="${song.path}" preload="none"></audio>
          <button class="btn ghost" onclick="deleteSong('${song.id}')">Delete</button>
        </div>
      `;
      list.appendChild(div);
    });
  } catch (error) {
    console.error('Error loading songs:', error);
    document.getElementById('songsList').innerHTML = 
      `<div class="song-item" style="color:var(--accent2)">Error loading songs: ${error.message}</div>`;
  }
}

async function deleteSong(id) {
  if (!confirm('Delete this song?')) return;
  
  const res = await fetch('/api/songs/' + encodeURIComponent(id), {
    method: 'DELETE',
    headers: {
      'X-Auth-Token': token
    }
  });
  
  if (res.ok) {
    alert('Song deleted');
    loadSongs();
  } else {
    alert('Failed to delete song');
  }
}

document.getElementById('musicFile').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  if (!file.type.includes('audio')) {
    alert('Please select an audio file');
    e.target.value = '';
    return;
  }

  const formData = new FormData();
  formData.append('music', file);
  formData.append('title', document.getElementById('songTitle').value || file.name.replace('.mp3', ''));
  formData.append('artist', document.getElementById('songArtist').value || 'Unknown Artist');

  try {
    console.log('Uploading file:', file.name);
    const res = await fetch('/api/upload-music', {
      method: 'POST',
      headers: {
        'X-Auth-Token': token
      },
      body: formData
    });

    const data = await res.json();
    console.log('Upload response:', data);

    if (!res.ok || !data.ok) {
      throw new Error(data.error || 'Upload failed');
    }

    document.getElementById('songTitle').value = '';
    document.getElementById('songArtist').value = '';
    document.getElementById('musicFile').value = '';
    await loadSongs();
    alert('Song uploaded successfully!');
  } catch (err) {
    console.error('Upload error:', err);
    alert('Upload failed: ' + err.message);
  }
});

// Handle file upload
document.getElementById('imageFile').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  // Validate file type
  if (!file.type.startsWith('image/')) {
    alert('Please select an image file');
    e.target.value = '';
    return;
  }

  // Validate file size (max 5MB)
  if (file.size > 5 * 1024 * 1024) {
    alert('Image file is too large. Maximum size is 5MB.');
    e.target.value = '';
    return;
  }

  const formData = new FormData();
  formData.append('image', file);

  // Show loading state
  const imageInput = document.getElementById('image');
  const originalValue = imageInput.value;
  imageInput.value = 'Uploading...';
  imageInput.disabled = true;

  try {
    console.log('Uploading image:', file.name);
    const res = await fetch('/api/upload', {
      method: 'POST',
      headers: {
        'X-Auth-Token': token
      },
      body: formData
    });

    const data = await res.json();
    console.log('Upload response:', data);

    if (!res.ok || !data.ok) {
      throw new Error(data.error || 'Upload failed');
    }

    imageInput.value = data.path;
    
    // Show success message
    const successMsg = document.createElement('div');
    successMsg.style.cssText = 'position:fixed;top:20px;right:20px;background:var(--accent);color:#fff;padding:12px 20px;border-radius:8px;animation:slideIn 0.3s ease;z-index:1000;';
    successMsg.textContent = 'Image uploaded successfully';
    document.body.appendChild(successMsg);
    setTimeout(() => successMsg.remove(), 3000);

  } catch (err) {
    console.error('Upload error:', err);
    
    // Show error message
    const errorMsg = document.createElement('div');
    errorMsg.style.cssText = 'position:fixed;top:20px;right:20px;background:var(--accent2);color:#fff;padding:12px 20px;border-radius:8px;animation:slideIn 0.3s ease;z-index:1000;';
    errorMsg.textContent = 'Upload failed: ' + err.message;
    document.body.appendChild(errorMsg);
    setTimeout(() => errorMsg.remove(), 5000);
    
    // Restore original value if there was one
    imageInput.value = originalValue;
  } finally {
    imageInput.disabled = false;
    e.target.value = ''; // Reset file input
  }
});
</script>
</body>
</html>
